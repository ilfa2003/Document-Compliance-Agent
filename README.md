# Shirawi AI Document Compliance Agent

A modular, extensible system for automated document compliance checking and reporting.

---

## üìÅ Folder Structure

The Challenge Project Structure is shown Below:
```
üìÅ Shirawi-AI-Challenge/
‚îÇ
‚îú‚îÄ‚îÄ üìÅ entities/               # Domain models
‚îÇ   ‚îú‚îÄ‚îÄ document.py            # Business document model
‚îÇ   ‚îú‚îÄ‚îÄ compliance_rule.py     # Compliance rule model
‚îÇ   ‚îî‚îÄ‚îÄ result.py              # Compliance result model
‚îÇ
‚îú‚îÄ‚îÄ üìÅ use_cases/              # Application business logic
‚îÇ   ‚îú‚îÄ‚îÄ extract.py             # Data extraction logic
‚îÇ   ‚îú‚îÄ‚îÄ compliance.py          # Compliance checking logic
‚îÇ   ‚îú‚îÄ‚îÄ rag.py                 # Retrieval-Augmented Generation (RAG) logic
‚îÇ   ‚îî‚îÄ‚îÄ compliance_rules.py    # Rule definitions
‚îÇ
‚îú‚îÄ‚îÄ üìÅ adapters/               # External system interfaces
‚îÇ   ‚îú‚îÄ‚îÄ mongo_repository.py    # MongoDB integration
‚îÇ   ‚îú‚îÄ‚îÄ llm_service.py         # Large Language Model (LLM) integration
‚îÇ   ‚îî‚îÄ‚îÄ file_adapter.py        # File I/O utilities
‚îÇ
‚îú‚îÄ‚îÄ üìÅ cli/                    # Command-line interface
‚îÇ   ‚îî‚îÄ‚îÄ main.py                # Application entrypoint
‚îÇ
‚îú‚îÄ‚îÄ üìÅ config/                 # Application configuration
‚îÇ   ‚îî‚îÄ‚îÄ settings.py            # Configuration and environment variables
‚îÇ
‚îú‚îÄ‚îÄ üìÅ documents/              # Document storage
‚îÇ   ‚îú‚îÄ‚îÄ customs-certificate     # Sample Invoice PDFs 
‚îÇ   ‚îú‚îÄ‚îÄ declaration             
‚îÇ   ‚îú‚îÄ‚îÄ invoice          
‚îÇ   ‚îú‚îÄ‚îÄ waybill                  
‚îú‚îÄ‚îÄ requirements.txt           # Python dependencies
‚îî‚îÄ‚îÄ README.md                  # Project documentation
```

---

## üß© Component Overview

- **entities/**: Core business models (Document, ComplianceRule, ComplianceResult).
- **use_cases/**: Application logic (extraction, compliance, RAG, rule definitions).
- **adapters/**: Interfaces to external systems (MongoDB, LLM, file system).
- **cli/**: Command-line interface for running workflows.
- **config/**: Centralized configuration and environment management.
- **documents/**: Input folder for your business documents (PDFs).

---

## üèóÔ∏è Architecture 


> **Architecture Diagram:**
>
![Attach your architecture diagram here](architecture-diagram.png)


- **CLI**: Entry point for user commands and workflow orchestration.
- **Use Cases**: Business logic for extraction, compliance, and RAG.
- **Entities**: Core data models passed between layers.
- **Adapters**: Abstraction for database, LLM, and file system.
- **Config**: Centralized settings.
- **External Services**: MongoDB for storage/vector search, LLM for report generation, file system for document storage.
---
## ‚öôÔ∏è Tools, Models, and Reasoning Approach

- **OCR & Extraction**: Extracts structured data from inoices and supporting documents using Gemini OCR due to failed attempts of ocr recognition of handwritten text (see `use_cases/extract.py`).
- **MongoDB**: Stores extracted document data and supports vector search for RAG (Retrieval-Augmented Generation).
- **Vector Search**: Finds similar documents using embeddings, providing context for compliance decisions through MongoDB Atlas Vector Search.
- **LLM (Large Language Model)**: Used Gemini-1.5-pro via `adapters/llm_service.py` to generate human-readable compliance reports and explanations, leveraging both deterministic results and retrieved context.
- **Deterministic Rule Engine**: Programmatic validation of compliance rules (see `use_cases/compliance.py` and `use_cases/compliance_rules.py`).
- **RAG (Retrieval-Augmented Generation)**: Combines deterministic checks with context from similar documents and LLM reasoning for robust, context-aware compliance reporting. 
- **Dynamic Document Linking**: Links related documents (invoice, customs, waybill, etc.) using extracted values, not hardcoded IDs, for robust matching.

**üß† Reasoning Approach:**
- The system's first approach applies deterministic, programmatic rules for compliance with reason for failure generated by LLM.
- The system's second approach for ambiguous or complex cases where it augments reasoning with context from similar documents (via vector search) and LLM-generated explanations.
- This hybrid approach ensures both accuracy (via rules) and flexibility (via LLM and RAG,CAG).

**üè¶ RAG (Retrieval-Augmented Generation) + CAG (Context-Augmented Generation) Approach**

The system leverages a hybrid RAG + CAG pipeline to maximize compliance accuracy and context-awareness:
-  **Document Linking**:
In `use_cases/rag.py` and `use_cases/compliance.py`, the link_documents function dynamically associates related documents (invoice, customs, waybill, etc.) by extracting and matching key fields, rather than relying on hardcoded IDs. This ensures robust linkage even as document formats vary.
- **Deterministic Compliance Checks**:
The run_deterministic_checks function (see `use_cases/compliance.py`) applies a set of programmatic rules to the linked documents. Each rule is defined as a function (e.g., check_invoice_to_customs_match) and produces a structured result (ComplianceResult) with a pass/fail status and explanation.
- **Vector Search for Similar Documents (RAG)**:
In `use_cases/rag.py`, the vector_search_similar_docs function uses MongoDB Atlas Vector Search to retrieve top-k similar documents for each main document, based on their embeddings. This is orchestrated in the generate_rag_compliance_report function, which builds a rag_context dictionary mapping each document to its similar documents.
- **Context-Augmented Prompt Construction (CAG)**:
The generate_rag_compliance_report function then constructs a prompt for the LLM that includes:
The compliance rules (USER_RULES)
The JSON data of the linked documents
The deterministic rule results
The RAG context (similar documents for each main doc)
This prompt is passed to the LLM via the LLMService adapter, enabling the model to reason not only over the current documents and rule results, but also over patterns and context from similar, previously processed invoices.

üìå **Note:** The RAG + CAG approach becomes more effective as the database grows, since a larger and more diverse set of invoices provides richer context for vector search and enhances the LLM‚Äôs compliance reasoning. 

---

## üöÄ Getting Started

 üìå **Note:** This project requires Python 3.10 or higher. The implementation is designed specifically to cater to the use case of the sample invoices provided. 

### 1. **Create & activate a Virtual Environment**
```bash
#Create
python -m venv venv #You can change the name of the venv

#Activate
venv\Scripts\activate
```

### 2. **Install Dependencies**

```bash
pip install -r requirements.txt
```

### 3. **Prepare Your Documents**

- Place your PDF files (invoices, customs declarations, etc.) in the `documents/` folder. (*Note*: The sample documents are in the folder for testing)

### 4. **Configure Environment**

- Edit `config/settings.py` or use a `.env` file for database and API keys as needed. 
   ```bash
   #.env
   GOOGLE_API_KEY=YOUR-GEMINI-API-KEY
   ROBOFLOW_API_KEY=YOUR-ROBOFLOW-API-KEY
   MONGO_URI=YOUR-MONGO-URI
   ```
- Create a [Gemini API key](https://aistudio.google.com/app/apikey).
- Create a [MongoDB Cluster](https://www.mongodb.com/docs/atlas/getting-started/) -> [Copy the MongoDB connection String](https://www.mongodb.com/docs/atlas/tutorial/connect-to-your-cluster/) (From the Homepage after creating a cluster `get connection string`).
- Create a [Roboflow API Key](https://docs.roboflow.com/developer/authentication/find-your-roboflow-api-key) (**optional**: for OCR testing)

### 5. **MongoDB Database, Collection, Vector Index**

- Create a database `document_compliance` and a collection in it `invoices-test`. (Incase any name change make sure all the name instances are updated in these files `adapters\mongo_repository.py`,`config\settings.py`, `fallbacks\extract_invoice1.py, extract_invoice2.py, extract_invoice3.py, extract_invoice4.py, extract_invoice5.py`).
- Run the file `mongoDB vector index\vector-index.py` to create a vector index. (Additionally after running the CLI, can test the vector search through `mongoDB vector index\vector-test.py`)


### 6. **Run the CLI**

```bash
python -m cli.main . --help
```

- Use the CLI to run extraction, compliance checks, and generate reports.
- Example:  
  ```bash
  '''--extract - To run ocr on invoices and save the fields and embeddings in MongoDB
     --report - To run compliance agent with deterministic rules & LLM reasoning
     --rag_report - To run compliance agent with deterministic rules combined with rag_context
  '''
  python -m cli.main . --extract --report --rag_report
  ```
- The user rules in natural language are defined in `use_cases\compliance_rules.py`.
---

## üìö Example Workflow

1. **Extract Data:**  
   Extracts structured data from PDFs in `documents/`.

2. **Link Documents:**  
   Links related documents using robust, dynamic matching.

3. **Run Compliance Checks:**  
   Applies deterministic rules to linked documents.

4. **Generate Report:**  
   Produces a compliance report, optionally enhanced with RAG and LLM explanations.

---
## üîé OCR Testing
- Traditional OCR methods were applied on scanned PDF's with handwritten text however it faced shortcomings.
- **Tesseract**: Best for clean, printed text; struggles with cursive or irregular handwriting. ([ocr-test\tesseract.py](ocr-test\tesseract.py))
- **EasyOCR**: Better than Tesseract for some handwriting, but still limited by its model size and training data.([ocr-test\ocr.py](ocr-test\ocr.py))
- **Roboflow**: Performed well with structured PDF's but struggled with scanned handwritten PDF's.([ocr-test\roboflow.py](ocr-test\roboflow.py), [ocr-test\roboflow2.py](ocr-test\roboflow2.py))
- Gemini LLM OCR delivers superior handwritten PDF recognition by leveraging advanced AI models for context-aware accuracy, and remains efficient for batch processing since computation is offloaded to scalable cloud APIs. (Check results at `gemini-ocr`)
---
## ‚ö†Ô∏è Limitations of Current Implementation
- **Template/Format Sensitivity**:
The system may struggle with unseen invoice layouts, non-standard fields, or documents with unusual structures, leading to extraction or linking errors. Dynamic extraction, linking logic and conditional checks needs development.
- **Handwriting and Low-Quality Scans**:
While Gemini LLM OCR improves recognition, extremely poor scan quality, heavy noise, or highly stylized handwriting can still cause misreads.
- **Language and Locale Diversity**:
Invoices in different languages (In this case Arabic), scripts, or with region-specific terms may not be fully supported without additional language models or rules.

---
## üîú Future Improvements
- **Adaptive Template Learning**:
Implement machine learning models that can learn new invoice templates and layouts from user feedback or unsupervised clustering.
- **Active Learning & Human-in-the-Loop**:
Integrate feedback loops where users can correct extraction/compliance errors, allowing the system to improve over time.
- **Multilingual & Multimodal Support**:
Expand support for more languages, scripts, and document types (e.g., images, plain text, receipts, contracts) using specialized models.
- **Dynamic Rule Authoring**:
Develop a user-friendly interface for business users to define or update compliance rules without code changes.
- **Enhanced Contextual Reasoning**:
Incorporate graph-based or knowledge-based reasoning to better understand relationships between entities across documents rather than strict deterministic rules.

---
## üìû Support

For questions or contributions, please feel free to reach out at `f20210048@dubai.bits-pilani.ac.in`. 